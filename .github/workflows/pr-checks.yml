name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  # Job 1: PR Information
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest
    steps:
      - name: PR Details
        run: |
          echo "üìã Pull Request: #${{ github.event.pull_request.number }}"
          echo "üë§ Author: ${{ github.event.pull_request.user.login }}"
          echo "üåø Branch: ${{ github.head_ref }} ‚Üí ${{ github.base_ref }}"
          echo "üìù Title: ${{ github.event.pull_request.title }}"

  # Job 2: Quick validation
  validate:
    name: Quick Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Type check
        run: pnpm type-check

      - name: Format check
        run: pnpm format:check

  # Job 3: Backend tests
  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run backend tests with coverage
        run: pnpm --filter @caeli/backend test:coverage

      - name: Comment coverage on PR
        uses: romeovs/lcov-reporter-action@v0.3.1
        if: github.event_name == 'pull_request'
        with:
          lcov-file: ./apps/backend/coverage/lcov.info
          github-token: ${{ secrets.GITHUB_TOKEN }}
          delete-old-comments: true

  # Job 4: Build check
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [validate, test-backend]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build backend
        run: pnpm --filter @caeli/backend build

      - name: Build success
        run: echo "‚úÖ Build completed successfully"

  # Job 5: PR Status Summary
  pr-status:
    name: PR Status Summary
    runs-on: ubuntu-latest
    needs: [validate, test-backend, build]
    if: always()
    steps:
      - name: Check job status
        run: |
          if [ "${{ needs.validate.result }}" == "success" ] && \
             [ "${{ needs.test-backend.result }}" == "success" ] && \
             [ "${{ needs.build.result }}" == "success" ]; then
            echo "‚úÖ All PR checks passed!"
            echo "This PR is ready for review."
          else
            echo "‚ùå Some checks failed"
            echo "Please review the failed jobs above"
            exit 1
          fi
